<!DOCTYPE html>
<html lang="zh-Hant" x-data="{ 
          darkMode: localStorage.getItem('darkMode') === 'true' || false
      }" :class="{ 'dark': darkMode }" x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Flask 天氣應用{% endblock %}</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Theme Color (支援 Dark Mode) -->
    <meta name="theme-color" content="#3b82f6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e3a8a" media="(prefers-color-scheme: dark)">

    <!-- Apple Touch Icon (iOS) -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">

    <!-- Apple Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Weather">

    <!-- MS Tile (Windows) -->
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='icons/icon-144x144.png') }}">
    <meta name="msapplication-TileColor" content="#3b82f6">

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',  // 使用 class 策略
            theme: {
                extend: {}
            }
        }
    </script>
    <!-- 引入 Alpine.js (用於互動功能) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- 引入 Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet" />
    {% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% endblock %}
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- 導航列 -->
    <nav class="bg-blue-600 text-white shadow-md mb-8">
        <div class="container mx-auto px-4 py-4" x-data="{ mobileMenuOpen: false }">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-4">
                <div class="w-full sm:w-auto flex items-center justify-between">
                    <a class="text-xl font-bold" href="{{ url_for('main.index') }}">Weather App</a>
                    <button class="sm:hidden p-2 rounded hover:bg-blue-500" @click="mobileMenuOpen = !mobileMenuOpen"
                        aria-label="切換選單" aria-expanded="false" :aria-expanded="mobileMenuOpen.toString()">
                        <i class="ri-menu-line text-2xl"></i>
                    </button>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden sm:flex gap-4 items-center">
                    <a class="nav-item nav-link hover:text-blue-200"
                        href="{{ url_for('taiwan_weather.page') }}">台灣天氣</a>
                    <!-- 關於本站 Modal -->
                    <div x-data="{ open: false }">
                        <button @click="open = true" class="text-white hover:text-blue-200 underline text-sm">
                            關於本站
                        </button>

                        <!-- 背景遮罩 -->
                        <div x-show="open" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40" @click="open = false"
                            style="display: none;"></div>

                        <!-- Modal 本體 -->
                        <div x-show="open" x-transition
                            class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-50 w-full max-w-sm"
                            style="display: none;">
                            <h4 class="text-xl font-bold mb-2 text-gray-800">Weather App v1.0</h4>
                            <p class="text-gray-600 mb-4">由 Flask 與 OpenWeatherMap 驅動，使用 Alpine.js 提供互動體驗。</p>
                            <div class="text-sm text-gray-500 mb-4">
                                <p>特色功能：</p>
                                <ul class="list-disc list-inside">
                                    <li>即時天氣查詢</li>
                                    <li>5 天天氣預報</li>
                                    <li>空氣品質監測</li>
                                    <li>位置定位</li>
                                </ul>
                            </div>
                            <button @click="open = false"
                                class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                關閉
                            </button>
                        </div>
                    </div>

                    <!-- 單位切換下拉選單 -->
                    <div x-data="{ open: false }" class="relative">
                        <button @click="open = !open" @keydown.escape="open = false"
                            class="bg-white text-blue-600 px-3 py-1 rounded shadow flex items-center gap-2">
                            單位: {{ '°C' if session.get('units', 'metric') == 'metric' else '°F' }}
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div x-show="open" x-transition x-cloak @click.outside="open = false"
                            class="absolute right-0 mt-2 w-40 bg-white text-gray-800 rounded shadow-lg z-50">
                            <a href="{{ url_for('main.set_units', unit='metric') }}"
                                class="block px-4 py-2 hover:bg-gray-100">攝氏 (°C)</a>
                            <a href="{{ url_for('main.set_units', unit='imperial') }}"
                                class="block px-4 py-2 hover:bg-gray-100">華氏 (°F)</a>
                        </div>
                    </div>

                    <!-- Dark Mode Toggle Button (NEW) -->
                    <button @click="darkMode = !darkMode"
                        class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                        title="切換深色模式">
                        <i x-show="!darkMode" class="ri-moon-line text-2xl text-gray-700"></i>
                        <i x-show="darkMode" class="ri-sun-line text-2xl text-yellow-400"></i>
                    </button>

                    <!-- 使用者認證連結 -->
                    {% if current_user.is_authenticated %}
                    <a class="nav-item nav-link" href="{{ url_for('main.dashboard') }}">儀表板</a>
                    <span class="nav-item nav-link">Hi, {{ current_user.username }}</span>
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.logout') }}">登出</a>
                    {% else %}
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.login') }}">登入</a>
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.register') }}">註冊</a>
                    {% endif %}
                </div>
            </div>

            <!-- Mobile Menu -->
            <div x-show="mobileMenuOpen" x-cloak class="sm:hidden mt-4 border-t border-blue-500 pt-4 space-y-3">
                <div class="flex flex-col gap-3">
                    <a class="nav-item nav-link hover:text-blue-200"
                        href="{{ url_for('taiwan_weather.page') }}">台灣天氣</a>
                    <!-- 關於本站 Modal -->
                    <div x-data="{ open: false }">
                        <button @click="open = true" class="w-full text-left text-white hover:text-blue-200 underline">
                            關於本站
                        </button>

                        <div x-show="open" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40" @click="open = false"
                            style="display: none;"></div>

                        <div x-show="open" x-transition class="fixed inset-0 z-50 overflow-y-auto">
                            <div class="flex items-end sm:items-center justify-center min-h-screen p-0 sm:p-4">
                                <div class="fixed inset-0 bg-black opacity-50" @click="open = false"></div>
                                <div
                                    class="relative bg-white w-full sm:max-w-sm sm:rounded-lg max-h-screen sm:max-h-[90vh] overflow-y-auto">
                                    <div
                                        class="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                                        <h4 class="text-lg font-semibold text-gray-800">Weather App v1.0</h4>
                                        <button @click="open = false" class="text-gray-500 p-2 -mr-2" aria-label="關閉">
                                            <i class="ri-close-line text-2xl"></i>
                                        </button>
                                    </div>
                                    <div class="p-4 text-gray-700">
                                        <p class="mb-4">由 Flask 與 OpenWeatherMap 驅動，使用 Alpine.js 提供互動體驗。</p>
                                        <div class="text-sm text-gray-600 mb-4">
                                            <p>特色功能：</p>
                                            <ul class="list-disc list-inside">
                                                <li>即時天氣查詢</li>
                                                <li>5 天天氣預報</li>
                                                <li>空氣品質監測</li>
                                                <li>位置定位</li>
                                            </ul>
                                        </div>
                                        <button @click="open = false"
                                            class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                            關閉
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 單位切換下拉選單 -->
                    <div x-data="{ open: false }" class="relative">
                        <button @click="open = !open" @keydown.escape="open = false"
                            class="w-full bg-white text-blue-600 px-3 py-2 rounded shadow flex items-center justify-between">
                            <span>單位: {{ '°C' if session.get('units', 'metric') == 'metric' else '°F' }}</span>
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div x-show="open" x-transition x-cloak @click.outside="open = false"
                            class="mt-2 w-full bg-white text-gray-800 rounded shadow-lg z-50">
                            <a href="{{ url_for('main.set_units', unit='metric') }}"
                                class="block px-4 py-2 hover:bg-gray-100">攝氏 (°C)</a>
                            <a href="{{ url_for('main.set_units', unit='imperial') }}"
                                class="block px-4 py-2 hover:bg-gray-100">華氏 (°F)</a>
                        </div>
                    </div>

                    <button @click="darkMode = !darkMode"
                        class="w-full bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded flex items-center justify-center gap-2">
                        <i x-show="!darkMode" class="ri-moon-line text-xl"></i>
                        <i x-show="darkMode" class="ri-sun-line text-xl"></i>
                        <span x-text="darkMode ? '切換為淺色' : '切換為深色'"></span>
                    </button>

                    {% if current_user.is_authenticated %}
                    <a class="nav-item nav-link" href="{{ url_for('main.dashboard') }}">儀表板</a>
                    <span class="nav-item nav-link">Hi, {{ current_user.username }}</span>
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.logout') }}">登出</a>
                    {% else %}
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.login') }}">登入</a>
                    <a class="nav-item nav-link hover:text-blue-200" href="{{ url_for('auth.register') }}">註冊</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區塊 -->
    <div class="container mx-auto px-4">
        <!-- Flash 訊息顯示區 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <!-- 使用 Alpine.js 處理關閉功能 -->
        <div x-data="{ show: true }" x-show="show"
            class="mb-4 p-4 rounded relative {{ 'bg-blue-100 text-blue-700 border border-blue-400' if category == 'info' else 'bg-red-100 text-red-700 border border-red-400' }}"
            role="alert">
            <span class="block sm:inline">{{ message }}</span>
            <span @click="show = false" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
                <svg class="fill-current h-6 w-6 text-current" role="button" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20">
                    <title>Close</title>
                    <path
                        d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z" />
                </svg>
            </span>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    {% block scripts %}{% endblock %}

    <!-- Service Worker 註冊 -->
    <script>
        // 註冊 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker 註冊成功:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker 註冊失敗:', error);
                    });
            });
        }
    </script>
</body>

</html>