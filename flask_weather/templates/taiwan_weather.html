{% extends "base.html" %}

{% block title %}å°ç£å¤©æ°£ - Weather App{% endblock %}

{% block styles %}
{{ super() }}
<style>
    :root {
        --tw-ink: #5e5045;
        --tw-paper: #fdfbf7;
        --tw-wash-blue: #d6eaf8;
        --tw-wash-green: #e3f2c1;
        --tw-wash-yellow: #fef3d5;
        --tw-wash-pink: #fbe2e0;
    }

    .tw-bg {
        background-color: var(--tw-paper);
        background-image:
            radial-gradient(circle at 0% 0%, rgba(227, 242, 193, 0.6) 0%, transparent 50%),
            radial-gradient(circle at 100% 100%, rgba(214, 234, 248, 0.6) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(251, 226, 224, 0.35) 0%, transparent 55%);
        background-attachment: fixed;
    }

    .tw-card {
        border: 2px solid var(--tw-ink);
        border-radius: 18px 40px 16px 32px / 32px 16px 40px 18px;
        background: white;
        box-shadow: 0 10px 20px rgba(94, 80, 69, 0.08);
    }

    .tw-pill {
        border-radius: 999px;
        border: 2px solid var(--tw-ink);
        background: white;
        padding: 6px 16px;
        font-weight: 800;
    }

    .tw-scroll::-webkit-scrollbar {
        display: none;
    }

    .tw-scroll {
        scrollbar-width: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="tw-bg min-h-screen -mt-6 pt-6 pb-16">
    <div class="max-w-3xl mx-auto px-4">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-black text-slate-800">å°ç£å¤©æ°£</h1>
                <p class="text-slate-600">ä¸­å¤®æ°£è±¡ç½² 36 å°æ™‚é å ±</p>
            </div>
            <div class="flex items-center gap-3">
                <select id="citySelect" class="tw-pill text-slate-700 shadow">
                    <option>è¼‰å…¥ä¸­...</option>
                </select>
                <span id="updateTime" class="tw-pill text-sm text-slate-700">æ›´æ–°ä¸­...</span>
            </div>
        </div>

        <div id="heroCard" class="tw-card p-6 sm:p-8 text-center mb-8">
            <div class="text-5xl">ğŸŒ¤ï¸</div>
            <p class="text-slate-700 mt-4">è¼‰å…¥å¤©æ°£è³‡æ–™ä¸­...</p>
        </div>

        <h3 class="text-xl font-extrabold text-slate-800 mb-3">æ¥ä¸‹ä¾†æ€éº¼æ¨£ï¼Ÿ</h3>
        <div id="futureForecasts" class="tw-scroll flex gap-4 overflow-x-auto pb-2"></div>

        <div id="errorBox" class="hidden mt-6 tw-card p-4 text-center text-red-600 bg-red-50">
            å¤©æ°£è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const citySelect = document.getElementById('citySelect');
    const heroCard = document.getElementById('heroCard');
    const futureForecasts = document.getElementById('futureForecasts');
    const updateTime = document.getElementById('updateTime');
    const errorBox = document.getElementById('errorBox');

    let currentCity = localStorage.getItem('tw_selected_city') || 'taichung';

    function getWeatherIcon(weather) {
        if (!weather) return 'ğŸŒ¤ï¸';
        if (weather.includes('æ™´')) return 'â˜€ï¸';
        if (weather.includes('å¤šé›²')) return 'â›…';
        if (weather.includes('é™°')) return 'â˜ï¸';
        if (weather.includes('é›¨')) return 'ğŸŒ§ï¸';
        if (weather.includes('é›·')) return 'â›ˆï¸';
        return 'ğŸŒ¤ï¸';
    }

    function getAdvice(rainProb, maxTemp) {
        const rainValue = parseInt(rainProb || '0', 10);
        const tempValue = parseInt(maxTemp || '0', 10);

        let rainIcon = 'ğŸŒ‚';
        let rainText = 'ä¸ç”¨å¸¶å‚˜';
        if (rainValue > 30) {
            rainIcon = 'â˜‚ï¸';
            rainText = 'è¨˜å¾—å¸¶å‚˜ï¼';
        }

        let clothIcon = 'ğŸ‘•';
        let clothText = 'èˆ’é©ç©¿æ­';
        if (tempValue >= 28) {
            clothIcon = 'ğŸ½';
            clothText = 'çŸ­è¢–å‡ºç™¼';
        } else if (tempValue <= 20) {
            clothIcon = 'ğŸ§¥';
            clothText = 'åŠ ä»¶å¤–å¥—';
        }

        return { rainIcon, rainText, clothIcon, clothText };
    }

    function getTimePeriod(startTime) {
        const hour = new Date(startTime).getHours();
        if (hour >= 5 && hour < 11) return 'æ—©æ™¨';
        if (hour >= 11 && hour < 14) return 'ä¸­åˆ';
        if (hour >= 14 && hour < 18) return 'ä¸‹åˆ';
        if (hour >= 18 && hour < 23) return 'æ™šä¸Š';
        return 'æ·±å¤œ';
    }

    function renderWeather(data) {
        const forecasts = data.forecasts || [];
        if (!forecasts.length) {
            throw new Error('No forecast');
        }

        const current = forecasts[0];
        const others = forecasts.slice(1);
        const period = getTimePeriod(current.startTime);
        const avgTemp = Math.round((parseInt(current.maxTemp, 10) + parseInt(current.minTemp, 10)) / 2);
        const advice = getAdvice(current.rain, current.maxTemp);

        heroCard.innerHTML = `
            <div class="text-sm font-black text-slate-600 mb-3">${period}</div>
            <div class="text-6xl">${getWeatherIcon(current.weather)}</div>
            <div class="text-4xl font-black text-slate-800 mt-3">${avgTemp}Â°</div>
            <div class="text-xl font-bold text-slate-700 mt-2">${current.weather}</div>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="tw-card p-4">
                    <div class="text-2xl">${advice.rainIcon}</div>
                    <div class="font-bold text-slate-800 mt-2">${advice.rainText}</div>
                    <div class="text-sm text-slate-500 mt-1">é™é›¨ç‡ ${current.rain}</div>
                </div>
                <div class="tw-card p-4">
                    <div class="text-2xl">${advice.clothIcon}</div>
                    <div class="font-bold text-slate-800 mt-2">${advice.clothText}</div>
                    <div class="text-sm text-slate-500 mt-1">æœ€é«˜æº« ${current.maxTemp}</div>
                </div>
            </div>
        `;

        futureForecasts.innerHTML = '';
        const todayDate = new Date().getDate();

        others.forEach((forecast) => {
            let periodText = getTimePeriod(forecast.startTime);
            const fDate = new Date(forecast.startTime);
            if (fDate.getDate() !== todayDate) {
                periodText = `æ˜å¤©${periodText}`;
            }

            futureForecasts.innerHTML += `
                <div class="tw-card p-4 min-w-[150px] text-center bg-gradient-to-br from-white to-[rgba(214,234,248,0.6)]">
                    <div class="text-sm font-bold text-slate-600">${periodText}</div>
                    <div class="text-3xl mt-2">${getWeatherIcon(forecast.weather)}</div>
                    <div class="text-sm font-semibold text-slate-700 mt-2">${forecast.minTemp} ~ ${forecast.maxTemp}</div>
                    <div class="text-xs text-slate-500 mt-1">ğŸ’§ ${forecast.rain}</div>
                </div>
            `;
        });

        updateTime.textContent = data.updateTime || 'æ›´æ–°å®Œæˆ';
        errorBox.classList.add('hidden');
    }

    async function loadCities() {
        try {
            const res = await fetch('{{ url_for('taiwan_weather.cities') }}');
            const json = await res.json();
            if (!json.success) throw new Error('cities');

            citySelect.innerHTML = '';
            json.data.forEach((city) => {
                const option = document.createElement('option');
                option.value = city.code;
                option.textContent = city.name;
                if (city.code === currentCity) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });

            citySelect.addEventListener('change', (e) => {
                currentCity = e.target.value;
                localStorage.setItem('tw_selected_city', currentCity);
                fetchWeather();
            });
        } catch (error) {
            console.error('è¼‰å…¥åŸå¸‚åˆ—è¡¨å¤±æ•—', error);
        }
    }

    async function fetchWeather() {
        try {
            const res = await fetch(`/taiwan/weather/${currentCity}`);
            const json = await res.json();
            if (!json.success) throw new Error('weather');
            renderWeather(json.data);
        } catch (error) {
            console.error('è¼‰å…¥å¤©æ°£å¤±æ•—', error);
            errorBox.classList.remove('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCities();
        fetchWeather();
    });
</script>
{% endblock %}