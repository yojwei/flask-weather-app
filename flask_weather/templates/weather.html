{% extends "base.html" %}

{% block title %}{{ data.city }} 天氣資訊 - Weather App{% endblock %}

{# 採用 Style 2：柔和淡彩（預設白底 + 淡色 header） #}
{% set header_class = 'bg-blue-100' %}
{% set header_text_class = 'text-blue-900' %}
{% set body_class = 'bg-white' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-blue-100' %}

{% if '01' in data.icon %}
{# 晴天：暖色 header，淺淡 body #}
{% set header_class = 'bg-orange-100' %}
{% set header_text_class = 'text-orange-900' %}
{% set body_class = 'bg-orange-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-orange-100' %}
{% elif '02' in data.icon or '03' in data.icon or '04' in data.icon %}
{# 多雲/陰天：柔和灰藍 header #}
{% set header_class = 'bg-slate-100' %}
{% set header_text_class = 'text-slate-700' %}
{% set body_class = 'bg-slate-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-slate-200' %}
{% elif '09' in data.icon or '10' in data.icon %}
{# 雨天：藍色系淡彩 #}
{% set header_class = 'bg-blue-100' %}
{% set header_text_class = 'text-blue-900' %}
{% set body_class = 'bg-blue-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-blue-100' %}
{% elif '11' in data.icon %}
{# 雷雨：靛青淡彩 #}
{% set header_class = 'bg-indigo-100' %}
{% set header_text_class = 'text-indigo-900' %}
{% set body_class = 'bg-indigo-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-indigo-100' %}
{% elif '13' in data.icon %}
{# 下雪：天藍淡彩 #}
{% set header_class = 'bg-sky-100' %}
{% set header_text_class = 'text-sky-900' %}
{% set body_class = 'bg-sky-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-sky-100' %}
{% elif '50' in data.icon %}
{# 霧：灰色淡彩 #}
{% set header_class = 'bg-gray-100' %}
{% set header_text_class = 'text-gray-800' %}
{% set body_class = 'bg-gray-50' %}
{% set body_text_class = 'text-slate-800' %}
{% set border_class = 'border border-gray-200' %}
{% endif %}

{% block content %}
<div class="flex justify-center">
    <div class="w-full">
        <div class="flex flex-col md:flex-row">
            <div
                class="shadow-md rounded-lg overflow-hidden transition-colors duration-300 {{ border_class }} bg-white dark:bg-gray-800 dark:border-gray-700 md:w-2/3 w-full mb-2">
                <div
                    class="{{ header_class }} {{ header_text_class }} dark:bg-gray-700 dark:text-gray-100 p-4 text-center flex justify-center items-end space-x-4">
                    <h2 class="text-3xl font-bold mb-0">{{ data.city }}, {{ data.country }}</h2>
                    {% if current_user.is_authenticated %}
                    {% if is_saved %}
                    <a href="{{ url_for('weather.unsave_city', city=data.city) }}"
                        class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-400 inset-ring inset-ring-gray-400/20"
                        title="取消收藏">
                        <i class="ri-heart-fill text-red-500"></i> 已收藏
                    </a>
                    {% else %}
                    <a href="{{ url_for('weather.save_city', city=data.city) }}"
                        class="inline-flex items-center rounded-md bg-gray-500/10 px-2 py-1 text-xs font-medium text-gray-400 inset-ring inset-ring-gray-400/20"
                        title="加入收藏">
                        <i class="ri-heart-line"></i> 收藏
                    </a>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="p-6 {{ body_class }} {{ body_text_class }} dark:bg-gray-800 dark:text-gray-100">
                    <div class="flex-col md:flex md:flex-wrap items-center text-center">
                        <div class="w-full md:w-1/2 mb-6 md:mb-0">
                            <!-- 使用 Filter 顯示圖示 -->
                            <div class="text-8xl mb-2">
                                <i class="{{ data.icon | weather_icon }}"></i>
                            </div>
                            <h2 class="text-6xl font-bold">{{ data.temp }}°{{ 'C' if session.get('units', 'metric') ==
                                'metric' else 'F' }}</h2>
                            <p class="text-xl capitalize">{{ data.description }}</p>
                        </div>

                        <!-- 桌面版顯示 -->
                        <div class="hidden md:block w-full md:w-1/2">
                            <ul class="divide-y divide-gray-200 dark:divide-gray-700 text-left">
                                <li class="py-3 flex justify-between items-center">
                                    <span><i class="ri-drop-fill text-blue-500 mr-2"></i>濕度</span>
                                    <span class="font-bold">{{ data.humidity }}%</span>
                                </li>
                                <li class="py-3 flex justify-between items-center">
                                    <span><i class="ri-windy-fill text-gray-500 mr-2"></i>風速</span>
                                    <span class="font-bold">{{ data.wind_speed }} m/s</span>
                                </li>
                                <li class="py-3 flex justify-between items-center">
                                    <span><i class="ri-temp-hot-fill text-red-500 mr-2"></i>體感溫度</span>
                                    <span class="font-bold">{{ data.feels_like }}°{{ 'C' if session.get('units',
                                        'metric')
                                        == 'metric' else 'F' }}</span>
                                </li>
                            </ul>
                        </div>

                        <!-- 手機版展開/收合功能 -->
                        <div x-data="{ expanded: false }" class="md:hidden w-full mt-4">
                            <button @click="expanded = !expanded"
                                class="w-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 font-semibold py-2 px-4 rounded flex justify-between items-center">
                                <span x-text="expanded ? '隱藏詳細資訊' : '顯示詳細資訊'"></span>
                                <i class="ri-arrow-down-s-line"
                                    :class="expanded ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                            </button>

                            <div x-show="expanded" x-transition
                                class="mt-3 bg-white dark:bg-gray-700 rounded shadow overflow-hidden">
                                <ul class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <li class="py-3 px-4 flex justify-between items-center">
                                        <span><i class="ri-drop-fill text-blue-500 mr-2"></i>濕度</span>
                                        <span class="font-bold">{{ data.humidity }}%</span>
                                    </li>
                                    <li class="py-3 px-4 flex justify-between items-center">
                                        <span><i class="ri-windy-fill text-gray-500 mr-2"></i>風速</span>
                                        <span class="font-bold">{{ data.wind_speed }} m/s</span>
                                    </li>
                                    <li class="py-3 px-4 flex justify-between items-center">
                                        <span><i class="ri-temp-hot-fill text-red-500 mr-2"></i>體感溫度</span>
                                        <span class="font-bold">{{ data.feels_like }}°{{ 'C' if session.get('units',
                                            'metric')
                                            == 'metric' else 'F' }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 dark:bg-gray-700 p-3 text-right text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-600">
                    更新時間: {{ data.dt }}
                </div>
            </div>

            <div class="flex flex-col w-full md:w-1/3 md:pl-2 md:gap-6">
                {% if pollution %}
                {% set aqi_val = pollution.list[0].main.aqi %}
                {% set aqi_map = {1: '優良', 2: '普通', 3: '對敏感族群不健康', 4: '不健康', 5: '非常不健康'} %}
                {% set aqi_color = {1: 'text-green-500', 2: 'text-yellow-500', 3: 'text-orange-500', 4: 'text-red-500',
                5:
                'text-purple-700'} %}

                <div class="w-full">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center h-full">
                        <h5 class="text-gray-500 dark:text-gray-400 text-lg mb-4">空氣品質 (AQI)</h5>
                        <i class="ri-mist-line text-6xl {{ aqi_color[aqi_val] }}"></i>
                        <h3 class="text-5xl font-bold {{ aqi_color[aqi_val] }} my-4">{{ aqi_val }}</h3>
                        <p class="text-gray-700 mb-2">{{ aqi_map[aqi_val] }}</p>

                        <!-- 詳細污染物濃度 (選用) -->
                        <small class="text-gray-400 text-sm">PM2.5: {{ pollution.list[0].components.pm2_5 }}
                            μg/m³</small>
                    </div>
                </div>
                {% endif %}

                <div class="w-full">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 text-center h-full">
                        <h5 class="text-gray-500 dark:text-gray-400 text-lg mb-4">日出與日落</h5>
                        <div class="flex justify-around items-center mt-6">
                            <div class="flex flex-col items-center">
                                <i class="ri-sun-line text-6xl text-yellow-500 mb-2"></i>
                                <p class="text-gray-700 font-semibold">{{ data.sunrise }}</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <i class="ri-moon-line text-6xl text-gray-600 mb-2"></i>
                                <p class="text-gray-700 font-semibold">{{ data.sunset }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-10">
            <h3 class="text-2xl font-bold mb-6 dark:text-gray-100">未來 5 天預報</h3>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                {% for date, items in forecast.items() %}
                <div x-data="{ open: false }" class="relative">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow h-full flex flex-col">
                        <div
                            class="bg-gray-100 dark:bg-gray-700 p-3 text-center font-semibold rounded-t-lg border-b dark:border-gray-600 dark:text-gray-100">
                            {{ date }} {{ items[0]['weekday'] }}
                        </div>
                        <div class="p-4 flex-grow flex flex-col items-center justify-center">
                            <!-- 這裡只顯示每天的中午 12:00 或第一筆資料作為代表 -->
                            {% set daily_rep = items[4] if items|length > 4 else items[0] %}
                            <div class="text-center">
                                <div class="text-4xl mb-2">
                                    <i class="bi {{ daily_rep.icon | weather_icon }}"></i>
                                </div>
                                <p class="text-xl font-bold mb-0">{{ daily_rep.temp }}°</p>
                                <small class="text-gray-500">{{ daily_rep.description }}</small>
                            </div>
                        </div>
                        <!-- Button trigger modal for details -->
                        <button @click="open = true"
                            class="m-2 py-1 px-3 border border-blue-500 dark:border-blue-400 text-blue-500 dark:text-blue-400 rounded hover:bg-blue-50 dark:hover:bg-gray-700 transition text-sm">
                            詳細資訊
                        </button>
                    </div>

                    <!-- Modal (詳細每 3 小時資訊) -->
                    <div x-show="open" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
                        <div
                            class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                            <div class="fixed inset-0 transition-opacity" aria-hidden="true" @click="open = false">
                                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                            </div>

                            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
                                aria-hidden="true">&#8203;</span>

                            <div
                                class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                    <div class="sm:flex sm:items-start">
                                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mb-4"
                                                id="modal-title">
                                                {{ date }} 詳細預報
                                            </h3>
                                            <div class="mt-2">
                                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                                        <tr>
                                                            <th
                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                                時間</th>
                                                            <th
                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                                天氣</th>
                                                            <th
                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                                溫度</th>
                                                            <th
                                                                class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                                降雨機率</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody
                                                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                        {% for item in items %}
                                                        <tr>
                                                            <td
                                                                class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                {{ item.time }}</td>
                                                            <td
                                                                class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                                                <i class="bi {{ item.icon | weather_icon }}"></i>
                                                            </td>
                                                            <td
                                                                class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                {{ item.temp }}°</td>
                                                            <td
                                                                class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                                {{ item['pop'] }}%</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <button type="button"
                                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"
                                        @click="open = false">
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card shadow mt-4 bg-white dark:bg-gray-800 rounded-lg">
            <div class="card-header p-4">
                <h3 class="text-2xl font-bold mb-6 dark:text-gray-100">未來 36 小時資訊</h3>
            </div>
            <div class="card-body p-4">
                <canvas id="tempChart"></canvas>
                <div id="chartFallback" style="display:none;" class="text-center text-gray-500 dark:text-gray-400 mt-2">
                    無足夠預報資料可顯示圖表</div>
            </div>
        </div>
        <div class="mt-4 text-center">
            <a href="{{ url_for('main.index') }}"
                class="inline-block border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 font-semibold py-2 px-4 rounded">返回首頁</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartData = {{ chart_data | tojson }};
    const tempUnit = '{{ "C" if session.get("units","metric") == "metric" else "F" }}';

    const canvas = document.getElementById('tempChart');
    const fallback = document.getElementById('chartFallback');

    if (!chartData) {
        // 沒有圖表資料：隱藏 canvas 並顯示提示文字
        if (canvas) canvas.style.display = 'none';
        if (fallback) fallback.style.display = 'block';
    } else {
        // 顯示 canvas 並隱藏提示
        if (canvas) canvas.style.display = '';
        if (fallback) fallback.style.display = 'none';

        const ctx = canvas.getContext('2d');

        // 檢測當前是否為 Dark Mode
        const isDarkMode = document.documentElement.classList.contains('dark');
        const textColor = isDarkMode ? '#e5e7eb' : '#374151';
        const gridColor = isDarkMode ? '#374151' : '#e5e7eb';
        const tickColor = isDarkMode ? '#9ca3af' : '#6b7280';

        const weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: `溫度 (°${tempUnit})`,
                        data: chartData.temps,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4, // 曲線平滑度
                        yAxisID: 'y'
                    },
                    {
                        label: '降雨機率 (%)',
                        data: chartData.pops,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        type: 'bar', // 混合圖表：長條圖
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: {
                            color: textColor
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: tickColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '溫度',
                            color: textColor
                        },
                        ticks: {
                            color: tickColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '降雨機率',
                            color: textColor
                        },
                        ticks: {
                            color: tickColor
                        },
                        grid: { drawOnChartArea: false }, // 避免格線重疊
                        min: 0,
                        max: 100
                    }
                }
            }
        });

        // 監聽 Dark Mode 變化，重新繪製圖表
        const observer = new MutationObserver(() => {
            const isDark = document.documentElement.classList.contains('dark');
            const newTextColor = isDark ? '#e5e7eb' : '#374151';
            const newGridColor = isDark ? '#374151' : '#e5e7eb';
            const newTickColor = isDark ? '#9ca3af' : '#6b7280';

            weatherChart.options.plugins.legend.labels.color = newTextColor;
            weatherChart.options.scales.x.ticks.color = newTickColor;
            weatherChart.options.scales.x.grid.color = newGridColor;
            weatherChart.options.scales.y.ticks.color = newTickColor;
            weatherChart.options.scales.y.grid.color = newGridColor;
            weatherChart.options.scales.y.title.color = newTextColor;
            weatherChart.options.scales.y1.ticks.color = newTickColor;
            weatherChart.options.scales.y1.title.color = newTextColor;
            weatherChart.update();
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
</script>
{% endblock %}